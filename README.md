# AADRoles-OnPrem
Written to solve use-case where client needed to be able to assign members of on-prem AD groups to AAD Roles.

## Client Overview
Client is a highly distributed 60k+ workforce with distributed IT model across the globe
There Azure implementation is a federated hybrid identity on Microsoft Azure Government (MAG) using Azure AD Connect
On-premises Active Directory is considered the “source of truth” for all identities (users, groups, etc)
When new admin staff are hired, the client has an existing process to add these accounts to the appropriate on-premises administrative groups

## Problem to Solve
Client wanted to use existing on-premises Active Directory (AD) groups to assign Azure AD (AAD) Roles.
Example: Admin accounts in the on-premises AD groups that have permission to administer desktops should have the similar capability for Azure AD joined workstations

So how could we simplify the admin model so that users could be assigned their necessary Azure AD Role without administrative overhead of manually assigning users to roles within Azure AD

## We thought this would work but...
A new feature in Preview allows [Cloud Groups to Manage Role Assignments in Azure AD](https://docs.microsoft.com/en-us/azure/active-directory/roles/groups-concept)

### Limitations that stopped us (for a little while)
* The ability to use synchronized on-premises groups is not supported 
* The ability to use dynamic AAD groups is not supported at this time
* This capability does not support nesting of groups

## Our Solution
### Technical Requirements
* Use a PowerShell script to query members of a source group and add and remove them as direct members to the cloud groups flagged as isAssignableToRole
* Run this on a set schedule to ensure repeatable results
* Had to be scalable to handle 1-1/1-many/many-1/many-many scenarios

### 
Azure Storage Account
* Table storage to handle mapping of Source to Destination
Azure Automation (AA)
* Used to host and run PowerShell scripts
* Specific API permissions granted to RunAs account to limit security reach
PowerShell Modules
* Azure AD module
* Az.Storage/Az.Resources/AzTable/Az.Account from [Perform Azure Table storage operations with PowerShell | Microsoft Docs](https://docs.microsoft.com/en-us/azure/storage/tables/table-storage-how-to-use-powershell)
Azure Storage Explorer
* To be able to read/review contents of Azure Storage table

## Azure Storage Account Configuration
* Account Kind: StorageV2 (general purpose v2)
* Replication: LRS
* Performance/access tier: Standard/cool
* Table design
<table>
  <tr>
    <td>PartitionKey*</td>
    <td>RowKey**</td>
    <td>Source</td>
    <td>Destination</td>
    <td>TimeStamp</td>
  </tr>
  <tr>
    <td>RoleNameA</td>
    <td>1</td>
    <td>OnPrem1</td>
    <td>CloudGroupA</td>
    <td>Autogenerated</td>
  </tr>
    <tr>
    <td>RoleNameB</td>
    <td>2</td>
    <td>OnPrem2</td>
    <td>CloudGroupB</td>
    <td>Autogenerated</td>
  </tr>
  <tr>
    <td>RoleNameA</td>
    <td>3</td>
    <td>OnPrem3</td>
    <td>CloudGroupA</td>
    <td>Autogenerated</td>
  </tr>
</table>
\* Required property but does not need to be utilized (ie can be left blank). BUT user it for long-term performance/searchability reasons)

\** Must be unique per row

